<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery</title>
    <style>
        img {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <script>
        /*
            Remember to add a listener to wait for the content of the document to be fully loaded.

            To do here: 
            upon the user input of a "filter" button:
                read the filter inputs
                Go through all the json files in the "models" folder, using the data in model_data.json 
                    If the model satisfies the filters, add it to the queue
                sort the queue if a sort filter was applied: name, date, etc
                display the models from the queue into model_gallery. For each display:
                    load the thumbnail as a link. When hovered, the model name appears
                    when clicked, link to gallery/model.html with the model name as a parameter

            To do in gallery.html:
             - add filter UI and sort UI
                - tags, also year, has cp, has video, etc
             - make the models appear in neat columns

            Note: sometimes the json files don't update because the old versions are cached in the local browser. make sure the deployed version doesn't have this issue. for testing, use incognito
        */
        //helper
        async function fetchFile(filename) {
            return fetch(filename)
                .then(response => response.json())
                .catch(error => console.error('Error:', error));
        }
        function display(queue,displayCP = false){
            console.log(queue.length, "models found") //later write this to the html
            const modelGallery = document.getElementById('model_gallery');
            const modelCount = document.createElement('i');
            modelCount.textContent = "Models found: "+queue.length;
            modelGallery.appendChild(modelCount);

            for(const [filename,model] of queue){
                const modelDiv = document.createElement('div');
                modelDiv.classList.add('model');
                for(const tag of model.tags){
                    modelDiv.classList.add(tag);
                }
                modelGallery.appendChild(modelDiv);

                const modelLink = document.createElement('a');
                modelLink.href = `gallery/${filename.slice(0, -5)}.html`;
                modelDiv.appendChild(modelLink);

                const modelThumbnail = document.createElement('img');
                modelThumbnail.src = !displayCP?"src/thumbnails/"+model.photo[0]:"src/cps/"+model.cp[0];
                modelThumbnail.alt = model.name;
                modelLink.appendChild(modelThumbnail);
                // const modelName = document.createElement('p');
                // modelName.textContent = model.name;
                // modelLink.appendChild(modelName);
            }
        }

        async function search(tags=[],sort="date",displayCP=false){
            console.log("refreshing search.")
            const modelGallery = document.getElementById('model_gallery');
            while (modelGallery.firstChild) {
                modelGallery.removeChild(modelGallery.firstChild);
            }
            function filter(model,tags){
                // check if all tags are present
                //True: model gets added to queue
                for(const tag of tags){
                    if(!model.tags.includes(tag)){
                        return false;
                    }
                }
                return model.name != ""
            }
            function sort(queue,sort="date"){
                //inputs a queue and sorts based on user input
                //TODO: read user sorting input
                if (sort == "date"){
                    return queue.sort((a, b) => new Date(b[1].date) - new Date(a[1].date))
                }
                if (sort =="alphabetical"){
                    return queue.sort((a, b) => a[1].name.localeCompare(b[1].name))
                }
            }

            model_data = await fetchFile("model_data.json");
            queue = []
            for (const filename of model_data.filenames){
                model = await fetchFile("src/models/"+filename);
                if(filter(model,tags)){
                    queue.push([filename,model])
                }
            }
            display(sort(queue),displayCP);
        }
    </script>

    <h1>Gallery</h1>
    <p>this is gallery of all models</p>
    <div id="user_controls">
        <button id="search_all" onclick="search([])">All</button>
        <button id="search_portfolio" onclick="search(['portfolio'])">Portfolio</button>
        <button id="search_cps" onclick="search(['has_cp'],'date',true)">Display Crease Patterns</button>
        <button id="search_human" onclick="search(['human'])">Human Figures</button>
        <button id="search_animal" onclick="search(['animal'])">Animals</button>
    </div>
    </div>
    <div id="model_gallery">
    </div>


    <script>
        //default loadup
        search([]);


        /*
        If no models found, display "no models found"
        
        */
    </script>
</body>
</html>